<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
<script src="https://fireyauto.github.io/XBS/src.js"></script>
<style>
body {
	padding:0;
    margin:0;
    font-family: 'Fira Mono', monospace;
}
#code {
	width:100%;
    height:60%;
    margin:0;
    resize:none;
    font-family: 'Fira Mono', monospace;
    tab-size:4;
    z-index:99;
}
#code:focus{
	outline:0;
}
#output{
	border-left:5px solid #eeeeee;
    padding-left:10px;
}
</style>
<textarea id="code" placeholder="Code Here" contenteditable="true" spellcheck=false autocorrect=false autocapitalize=false></textarea><br>
<input type="button" value="Run Code" id="rc">
<input type="button" value="Clear Output" id="co"><br>
<h3>Output</h3>
<pre id="output"></pre>
<script>

const output = document.getElementById("output");

const _apply=(a,b)=>{
	for(let k in b){
    	let v = b[k];
        if(typeof v =="object"){
        	_apply(a[k],v);
        }else{
        	a[k]=v;
        }
    }
}

const make=(a,b,c)=>{
	let e=document.createElement(a);
    if(b){
    	_apply(e,b);
    }
    c.appendChild(e);
}

const JoinArray=(a,p)=>{
	let s = [];
    for(let v of a){
    	s.push(String(v));
    }
    return s.join(p)
}

const ToOutput=(Text,Color)=>{
	make("p",{
        	innerHTML:Text,
            style:{
            	marginTop:"0",
                marginBottom:"0",
                color:Color
            },
        },output);
}

const LibraryUtilities = {
	ReadOnlyObject:function(Properties={}){
		return new Proxy(Properties,{
			get:function(self,Name){
				return self[Name];	
			},
			set:function(){
				return;
			},
		});
	},
};

const Library = {
	log:function(...a){ToOutput(JoinArray(a),"#000000")},
    warn:function(...a){ToOutput(JoinArray(a),"#ff6f00")},
    info:function(...a){ToOutput(JoinArray(a),"#1a58ee")},
    error:function(a){throw Error(a)},
    document:document,
   	window:window,
    console:console,
    tostring:function(x){return String(x)},
    toint:function(x){return parseInt(x)},
    tofloat:function(x){return parseFloat(x)},
    type:function(V){
    	let T = typeof V;
        if(V instanceof Array)return"array";
        if(V===null||V===undefined)return"null";
        return T;
    },
    string:LibraryUtilities.ReadOnlyObject({
    	reverse:function(x){
        	return x.split("").reverse().join("");
        },
        char:function(x){
            return x.charCodeAt(0); 
        },
        byte:function(x){
            return String.fromCharCode(x);
        },
        lower:function(x){
            return x.toLowerCase();  
        },
        upper:function(x){
            return x.toUpperCase();  
        },
        split:function(x,b){
            return x.split(b||"");
        },
        at:function(x,b){
            return x.charAt(b);
        },
		repeat:function(x,a){
			return x.repeat(a);	
		},
        format:function(s,...a){
        	let formats={
            	"s":a=>String(a),
                "q":a=>`"${String(a)}"`,
                "a":a=>`'${String(a)}'`,
                "l":a=>String(a).toLowerCase(),
                "u":a=>String(a).toUpperCase(),
            };
            let i=0;
            let F=[];
            for(let k in formats)F.push(k);
            return s.replace(new RegExp(`\\%(${F.join("|")})`,"g"),function(m,d){
            	return formats[d](a[Math.min(i++,a.length-1)]);
            });
        }
    }),
    load:function(x="",g={}){
        return XBS(x,g);
    },
    array:LibraryUtilities.ReadOnlyObject({
    	find:function(a,x){
        	return a.indexOf(x);
        },
        remove:function(a,x){
        	a.splice(x,1);
        },
        insert:function(a,x,y){
        	if (y==undefined){
            	a.push(x);
            } else {
            	a.splice(x,0,y);
            }
        },
	append:function(a,b){
		a.push(b);	
	},
	prepend:function(a,b){
		a.unshift(b);	
	},
	delete:function(a,b){
		a.splice(a.indexOf(b),1);	
	},
        reverse:function(a){
            return [...a].reverse();
        },
        join:function(a,b){
            if (b==null||b==undefined){
                b=", ";
            }
            return a.join(b);
        },
        sort:function(a,b){
            return Array.prototype.sort.call(a,b);
        },
        has:function(a,b){
            return a.includes(b);
        },
    }),
    object:Object,
    math:LibraryUtilities.ReadOnlyObject({
        sin:function(x){
            return Math.sin(x);
        },
        cos:function(x){
            return Math.cos(x);
        },
        tan:function(x){
            return Math.tan(x);
        },
        acos:function(x){
            return Math.acos(x);
        },
        asin:function(x){
            return Math.asin(x);
        },
        atan:function(x){
            return Math.atan(x);
        },
        atan2:function(y,x){
            return Math.atan2(y,x);
        },
        rad:function(x){
            return x*(Math.PI/180);
        },
        deg:function(x){
            return x*(180/Math.PI);
        },
        random:function(mi,ma){
    	    return Math.floor(Math.random() * (ma-mi+1) + mi);
        },
        floor:function(x){
            return Math.floor(x);
        },
        ceil:function(x){
            return Math.ceil(x);
        },
        round:function(x){
            return Math.round(x);
        },
        sqrt:function(x){
            return Math.sqrt(x);
        },
        sqrt2:function(x,b=2){
            return x**(1/b);
        },
        pow:function(x,y){
            return Math.pow(x,y);
        },
        pi:Math.PI,
        e:Math.E,
        log:function(x){
            return Math.log(x);
        },
        logb:function(x,b=10){
            return Math.log10(x)/Math.log10(b);
        },
        log10:function(x){
            return Math.log10(x);
        },
        nround:function(x,y=0){
            let m = 10**y;
            return Math.floor(x*m+0.5)/m;
        },
        abs:function(x){
            return Math.abs(x);
        }
    }),
    time:function(){
    	return (Date.now()/1000);
    },
    delay:function(x,f,...a){
        window.setTimeout(()=>{
            f(...a);
        },x*1000);
    },
    json:LibraryUtilities.ReadOnlyObject({
        encode:function(x){
            return JSON.stringify(x);
        },
        decode:function(x){
            return JSON.parse(x);
        },
    }),
}

Library.env = Library;

//{{ Editor }}\\

String.prototype.removeHtmlTags = function(){
	return this.replace(/(\<[^>]+\>)/g,"");
}

function colorWord(t,c){
	return `<span style="color:${c}">${t}</span>`;
};

function highlight(text){
	return text.replace(/\w+/g,colorWord("$&","#ff0000"));
}

const code = document.getElementById("code");
const closingPairs=[
	["\"","\""],
    ["'","'"],
    ["`","`"],
    ["(",")"],
    ["{","}"],
    ["[","]"],
];
code.addEventListener("keydown",ev=>{
	let kc = ev.keyCode||ev.which;
    if(kc==9){
    	let{selectionStart:s,selectionEnd:e,value:v}=code;
        code.value=`${v.substring(0,s)}\t${v.substring(s,e)}${v.substring(e,v.length)}`;
        ev.preventDefault();
        code.setSelectionRange(s+1,e+1);
    }else if(ev.key=="Enter"){
    	let{selectionStart:s,selectionEnd:e,value:v}=code;
        let vv = v.substring(0,s);
        let tv = vv.split("\n").pop();
        let tabs = 0
        for(let i=0;i<=tv.length-1;i++){
        	if(tv.charAt(i)=="\t"){
            	tabs++;
            }else{
            	break;
            }
        }
        code.value=`${vv}\n${tabs>0?String.fromCharCode(9).repeat(tabs):""}${v.substring(e,v.length)}`;
        code.setSelectionRange(s+tabs+1,s+tabs+1);
        ev.preventDefault();
    }else if(ev.key=="Backspace"){
    	let{selectionStart:s,selectionEnd:e,value:v}=code;
        let x = v.charAt(s-1);
        let y = v.charAt(s);
        if(s!=e){return}
    	for(let p of closingPairs){
        	if(x==p[0]&&y==p[1]){
            	let pre = v.charAt(s-2);
                if(pre=="\\"){
                	return
                }
            	code.value = `${v.substring(0,s-1)}${v.substring(e+(p[1].length),v.length)}`;
                code.setSelectionRange(s-1,s-1);
                ev.preventDefault();
                break;
            }
        }
    }else {
    	let key = ev.key;
        for(let p of closingPairs){
        	if(key==p[1]){
            	let{selectionStart:s,selectionEnd:e,value:v}=code;
                if(s==e){
                	let pre = v.charAt(s-1);
                	if(pre=="\\"){
                		return
                	}
                	let x = v.charAt(s);
                    if(x==p[1]){
                    	code.setSelectionRange(s+p[1].length,s+p[1].length);
                    	ev.preventDefault();
                        break;
                    }
                }
            }
        	if(key==p[0]){
            	let{selectionStart:s,selectionEnd:e,value:v}=code;
                let pre = v.charAt(s-1);
                if(pre=="\\"){
                	return
                }
            	if(s==e){
            		code.value=`${v.substring(0,s)}${p[0]}${p[1]}${v.substring(e,v.length)}`;
                    code.setSelectionRange(s+p[0].length,s+p[0].length);
            	}else{
                	let l = v.substring(s,e);
                	code.value=`${v.substring(0,s)}${p[0]}${v.substring(s,e)}${p[1]}${v.substring(e,v.length)}`;
            		code.setSelectionRange(s+p[0].length+l.length,s+p[0].length+l.length);
            	}
                ev.preventDefault();
            	break;
            }
        }
    }
});

const rc = document.getElementById("rc");
const co = document.getElementById("co");

rc.addEventListener("mousedown",()=>{
	let r = XBS(code.value,Library);
    if(!r.Success){
    	ToOutput(r.Error,"#ff1234");
    }
});

co.addEventListener("mousedown",()=>{
	output.innerHTML="";
});

</script>
